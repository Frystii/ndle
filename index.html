<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Random Nintendo Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; color: #333; margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; }
    h1 { text-align: center; }
    button, input { display: block; margin: 10px auto; padding: 10px; font-size: 16px; }
    button { border: none; background: #0066cc; color: #fff; border-radius: 4px; cursor: pointer; }
    button:hover { background: #005bb5; }
    input { width: 80%; border: 1px solid #ccc; border-radius: 4px; }
    .search-box { margin: 20px auto; padding: 10px; background: #eaeaea; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
    th { background: #f0f0f0; }
    img.cover { width: 50px; height: auto; border-radius: 4px; }
    .bg-green { background: #c8e6c9; }
    .bg-yellow { background: #fff9c4; }
    .bg-red { background: #ffcdd2; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Random Nintendo Game</h1>
    <button id="new-game">New Random Game</button>
    <div id="game-info">
      <p>Loading...</p>
    </div>

    <div class="search-box">
      <input id="game-search" list="games-list" placeholder="Search games...">
      <button id="search-btn">Validate</button>
      <table id="search-results">
        <thead>
          <tr>
            <th>Cover</th>
            <th>Name (ID)</th>
            <th>Year</th>
            <th>Companies</th>
            <th>Genres</th>
            <th>Platforms</th>
            <th>Game Modes</th>
          </tr>
        </thead>
        <tbody>
          <!-- Search results will go here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- JSON global exporté par ton script Python, avec champ cover_url -->
  <script src="nintendo_games_slim.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let currentGame = null;

      function pickRandomGame() {
        currentGame = games[Math.floor(Math.random() * games.length)];
      }

      // Utilise directement cover_url généré par Python
      function coverUrl(path) {
        return path ? path : 'placeholder.png';
      }

      function showRandomGame() {
        pickRandomGame();
        const game = currentGame;
        const container = document.getElementById('game-info');
        const comps = [...new Set((game.involved_companies || []).map(ic => ic.company.name))];
        const genres = (game.genres || []).map(g => g.name);
        const plats = (game.platforms || []).map(p => p.name);
        const modes = (game.game_modes || []).map(m => m.name);
        const year = game.y
          || (game.release_dates && game.release_dates[0] && game.release_dates[0].y)
          || '';

        container.innerHTML = `
          <div><strong>Name:</strong> ${game.name} (${game.id})</div>
          ${year ? `<div><strong>Year:</strong> ${year}</div>` : ''}
          ${comps.length ? `<div><strong>Companies:</strong> ${comps.join(', ')}</div>` : ''}
          ${genres.length ? `<div><strong>Genres:</strong> ${genres.join(', ')}</div>` : ''}
          ${plats.length ? `<div><strong>Platforms:</strong> ${plats.join(', ')}</div>` : ''}
          ${modes.length ? `<div><strong>Game Modes:</strong> ${modes.join(', ')}</div>` : ''}
        `;
      }

      // Bouton New Random Game
      document.getElementById('new-game').addEventListener('click', () => {
        showRandomGame();
        document.querySelector('#search-results tbody').innerHTML = '';
      });

      // Construire la datalist
      const dl = document.createElement('datalist');
      dl.id = 'games-list';
      games.forEach(g => {
        const o = document.createElement('option');
        o.value = g.name;
        dl.appendChild(o);
      });
      document.body.appendChild(dl);

      // Coloration pour tableaux
      function colorArr(td, arr, cgSet) {
        const matchAny = arr.some(v => cgSet.has(v));
        const matchAll = arr.length === cgSet.size && arr.every(v => cgSet.has(v));
        if (matchAll) td.classList.add('bg-green');
        else if (matchAny) td.classList.add('bg-yellow');
        else td.classList.add('bg-red');
      }

      // Handler Validate
      document.getElementById('search-btn').addEventListener('click', () => {
        const input = document.getElementById('game-search');
        const name = input.value.trim();
        input.value = '';
        const game = games.find(g => g.name === name);
        if (!game) { console.error(`No exact match for "${name}"`); return; }

        const tbody = document.querySelector('#search-results tbody');
        if ([...tbody.querySelectorAll('tr')].some(tr => tr.cells[1].textContent.includes(`(${game.id})`))) {
          console.error(`Already added: ${game.name}`); return;
        }

        // Préparer
        const comps = [...new Set((game.involved_companies || []).map(ic => ic.company.name))];
        const genres = (game.genres || []).map(g => g.name);
        const plats = (game.platforms || []).map(p => p.name);
        const modes = (game.game_modes || []).map(m => m.name);
        const yearVal = game.y
          || (game.release_dates && game.release_dates[0] && game.release_dates[0].y)
          || '';
        const yearNum = parseInt(yearVal,10) || null;

        // Valeurs du jeu courant
        const cg = currentGame;
        const cgYear = parseInt(cg.y
          || (cg.release_dates && cg.release_dates[0] && cg.release_dates[0].y)
          || 0,10);
        const cgComps = new Set((cg.involved_companies||[]).map(ic=>ic.company.name));
        const cgGenres = new Set((cg.genres||[]).map(g=>g.name));
        const cgPlats = new Set((cg.platforms||[]).map(p=>p.name));
        const cgModes = new Set((cg.game_modes||[]).map(m=>m.name));

        // Créer la ligne
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><img class="cover" src="${coverUrl(game.cover_url)}" alt="${game.name}"></td>
          <td>${game.name} (${game.id})</td>
          <td>${yearVal}</td>
          <td>${comps.join(', ')}</td>
          <td>${genres.join(', ')}</td>
          <td>${plats.join(', ')}</td>
          <td>${modes.join(', ')}</td>
        `;

        // Color Name
        const nameTd = row.cells[1];
        (game.name === cg.name) ? nameTd.classList.add('bg-green') : nameTd.classList.add('bg-red');

        // Color Year + arrow
        const yearTd = row.cells[2];
        (yearNum === cgYear) ? yearTd.classList.add('bg-green') : yearTd.classList.add('bg-red');
        if (yearNum !== null) {
          yearTd.textContent = `${yearNum} ${yearNum < cgYear ? '▲' : '▼'}`;
        }

        // Color arrays
        colorArr(row.cells[3], comps, cgComps);
        colorArr(row.cells[4], genres, cgGenres);
        colorArr(row.cells[5], plats, cgPlats);
        colorArr(row.cells[6], modes, cgModes);

        tbody.appendChild(row);

        // Si correct, alert + new game + clear
        if (game.name === cg.name) {
          alert("Congratulations! You guessed it!");
          showRandomGame();
          tbody.innerHTML = '';
        }
      });

      // Affichage initial
      showRandomGame();
    });
  </script>
</body>
</html>
